export default class DOMIterator{constructor(e,t=!0,r=[],o=5e3){this.ctx=e,this.iframes=t,this.exclude=r,this.iframesTimeout=o}static matches(e,t){const r="string"==typeof t?[t]:t,o=e.matches||e.matchesSelector||e.msMatchesSelector||e.mozMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector;if(o){let t=!1;return r.every(r=>!o.call(e,r)||(t=!0,!1)),t}return!1}getContexts(){let e,t=[];return(e="undefined"!=typeof this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?this.ctx:"string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:[]).forEach(e=>{const r=t.filter(t=>t.contains(e)).length>0;-1!==t.indexOf(e)||r||t.push(e)}),t}getIframeContents(e,t,r=(()=>{})){let o;try{const t=e.contentWindow;if(o=t.document,!t||!o)throw new Error("iframe inaccessible")}catch(a){r()}o&&t(o)}isIframeBlank(e){const t="about:blank",r=e.getAttribute("src").trim();return e.contentWindow.location.href===t&&r!==t&&r}observeIframeLoad(e,t,r){let o=!1,a=null;const s=()=>{if(!o){o=!0,clearTimeout(a);try{this.isIframeBlank(e)||(e.removeEventListener("load",s),this.getIframeContents(e,t,r))}catch(c){r()}}};e.addEventListener("load",s),a=setTimeout(s,this.iframesTimeout)}onIframeReady(e,t,r){try{"complete"===e.contentWindow.document.readyState?this.isIframeBlank(e)?this.observeIframeLoad(e,t,r):this.getIframeContents(e,t,r):this.observeIframeLoad(e,t,r)}catch(o){r()}}waitForIframes(e,t){let r=0;this.forEachIframe(e,()=>!0,e=>{r++,this.waitForIframes(e.querySelector("html"),()=>{--r||t()})},e=>{e||t()})}forEachIframe(e,t,r,o=(()=>{})){let a=e.querySelectorAll("iframe"),s=a.length,c=0;a=Array.prototype.slice.call(a);const n=()=>{--s<=0&&o(c)};s||n(),a.forEach(e=>{DOMIterator.matches(e,this.exclude)?n():this.onIframeReady(e,o=>{t(e)&&(c++,r(o)),n()},n)})}createIterator(e,t,r){return document.createNodeIterator(e,t,r,!1)}createInstanceOnIframe(e){return new DOMIterator(e.querySelector("html"),this.iframes)}compareNodeIframe(e,t,r){if(e.compareDocumentPosition(r)&Node.DOCUMENT_POSITION_PRECEDING){if(null===t)return!0;if(t.compareDocumentPosition(r)&Node.DOCUMENT_POSITION_FOLLOWING)return!0}return!1}getIteratorNode(e){const t=e.previousNode();let r;return{prevNode:t,node:r=null===t?e.nextNode():e.nextNode()&&e.nextNode()}}checkIframeFilter(e,t,r,o){let a=!1,s=!1;return o.forEach((e,t)=>{e.val===r&&(a=t,s=e.handled)}),this.compareNodeIframe(e,t,r)?(!1!==a||s?!1===a||s||(o[a].handled=!0):o.push({val:r,handled:!0}),!0):(!1===a&&o.push({val:r,handled:!1}),!1)}handleOpenIframes(e,t,r,o){e.forEach(e=>{e.handled||this.getIframeContents(e.val,e=>{this.createInstanceOnIframe(e).forEachNode(t,r,o)})})}iterateThroughNodes(e,t,r,o,a){const s=this.createIterator(t,e,o);let c,n,i=[],h=[],l=()=>(({prevNode:n,node:c}=this.getIteratorNode(s)),c);for(;l();)this.iframes&&this.forEachIframe(t,e=>this.checkIframeFilter(c,n,e,i),t=>{this.createInstanceOnIframe(t).forEachNode(e,e=>h.push(e),o)}),h.push(c);h.forEach(e=>{r(e)}),this.iframes&&this.handleOpenIframes(i,e,r,o),a()}forEachNode(e,t,r,o=(()=>{})){const a=this.getContexts();let s=a.length;s||o(),a.forEach(a=>{const c=()=>{this.iterateThroughNodes(e,a,t,r,()=>{--s<=0&&o()})};this.iframes?this.waitForIframes(a,c):c()})}};