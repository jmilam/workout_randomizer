import DOMIterator from"./domiterator";export default class Mark{constructor(t){this.ctx=t,this.ie=!1;const e=window.navigator.userAgent;(e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1)&&(this.ie=!0)}set opt(t){this._opt=Object.assign({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,diacritics:!0,synonyms:{},accuracy:"partially",acrossElements:!1,caseSensitive:!1,ignoreJoiners:!1,ignoreGroups:0,ignorePunctuation:[],wildcards:"disabled",each:()=>{},noMatch:()=>{},filter:()=>!0,done:()=>{},debug:!1,log:window.console},t)}get opt(){return this._opt}get iterator(){return new DOMIterator(this.ctx,this.opt.iframes,this.opt.exclude,this.opt.iframesTimeout)}log(t,e="debug"){const s=this.opt.log;this.opt.debug&&"object"==typeof s&&"function"==typeof s[e]&&s[e](`mark.js: ${t}`)}escapeStr(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}createRegExp(t){return"disabled"!==this.opt.wildcards&&(t=this.setupWildcardsRegExp(t)),t=this.escapeStr(t),Object.keys(this.opt.synonyms).length&&(t=this.createSynonymsRegExp(t)),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(t=this.setupIgnoreJoinersRegExp(t)),this.opt.diacritics&&(t=this.createDiacriticsRegExp(t)),t=this.createMergedBlanksRegExp(t),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(t=this.createJoinersRegExp(t)),"disabled"!==this.opt.wildcards&&(t=this.createWildcardsRegExp(t)),t=this.createAccuracyRegExp(t)}createSynonymsRegExp(t){const e=this.opt.synonyms,s=this.opt.caseSensitive?"":"i",i=this.opt.ignoreJoiners||this.opt.ignorePunctuation.length?"\0":"";for(let r in e)if(e.hasOwnProperty(r)){const n=e[r],o="disabled"!==this.opt.wildcards?this.setupWildcardsRegExp(r):this.escapeStr(r),a="disabled"!==this.opt.wildcards?this.setupWildcardsRegExp(n):this.escapeStr(n);""!==o&&""!==a&&(t=t.replace(new RegExp(`(${this.escapeStr(o)}|${this.escapeStr(a)})`,`gm${s}`),i+`(${this.processSynomyms(o)}|`+`${this.processSynomyms(a)})`+i))}return t}processSynomyms(t){return(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(t=this.setupIgnoreJoinersRegExp(t)),t}setupWildcardsRegExp(t){return(t=t.replace(/(?:\\)*\?/g,t=>"\\"===t.charAt(0)?"?":"\x01")).replace(/(?:\\)*\*/g,t=>"\\"===t.charAt(0)?"*":"\x02")}createWildcardsRegExp(t){let e="withSpaces"===this.opt.wildcards;return t.replace(/\u0001/g,e?"[\\S\\s]?":"\\S?").replace(/\u0002/g,e?"[\\S\\s]*?":"\\S*")}setupIgnoreJoinersRegExp(t){return t.replace(/[^(|)\\]/g,(t,e,s)=>{let i=s.charAt(e+1);return/[(|)\\]/.test(i)||""===i?t:t+"\0"})}createJoinersRegExp(t){let e=[];const s=this.opt.ignorePunctuation;return Array.isArray(s)&&s.length&&e.push(this.escapeStr(s.join(""))),this.opt.ignoreJoiners&&e.push("\\u00ad\\u200b\\u200c\\u200d"),e.length?t.split(/\u0000+/).join(`[${e.join("")}]*`):t}createDiacriticsRegExp(t){const e=this.opt.caseSensitive?"":"i",s=this.opt.caseSensitive?["a\xe0\xe1\u1ea3\xe3\u1ea1\u0103\u1eb1\u1eaf\u1eb3\u1eb5\u1eb7\xe2\u1ea7\u1ea5\u1ea9\u1eab\u1ead\xe4\xe5\u0101\u0105","A\xc0\xc1\u1ea2\xc3\u1ea0\u0102\u1eb0\u1eae\u1eb2\u1eb4\u1eb6\xc2\u1ea6\u1ea4\u1ea8\u1eaa\u1eac\xc4\xc5\u0100\u0104","c\xe7\u0107\u010d","C\xc7\u0106\u010c","d\u0111\u010f","D\u0110\u010e","e\xe8\xe9\u1ebb\u1ebd\u1eb9\xea\u1ec1\u1ebf\u1ec3\u1ec5\u1ec7\xeb\u011b\u0113\u0119","E\xc8\xc9\u1eba\u1ebc\u1eb8\xca\u1ec0\u1ebe\u1ec2\u1ec4\u1ec6\xcb\u011a\u0112\u0118","i\xec\xed\u1ec9\u0129\u1ecb\xee\xef\u012b","I\xcc\xcd\u1ec8\u0128\u1eca\xce\xcf\u012a","l\u0142","L\u0141","n\xf1\u0148\u0144","N\xd1\u0147\u0143","o\xf2\xf3\u1ecf\xf5\u1ecd\xf4\u1ed3\u1ed1\u1ed5\u1ed7\u1ed9\u01a1\u1edf\u1ee1\u1edb\u1edd\u1ee3\xf6\xf8\u014d","O\xd2\xd3\u1ece\xd5\u1ecc\xd4\u1ed2\u1ed0\u1ed4\u1ed6\u1ed8\u01a0\u1ede\u1ee0\u1eda\u1edc\u1ee2\xd6\xd8\u014c","r\u0159","R\u0158","s\u0161\u015b\u0219\u015f","S\u0160\u015a\u0218\u015e","t\u0165\u021b\u0163","T\u0164\u021a\u0162","u\xf9\xfa\u1ee7\u0169\u1ee5\u01b0\u1eeb\u1ee9\u1eed\u1eef\u1ef1\xfb\xfc\u016f\u016b","U\xd9\xda\u1ee6\u0168\u1ee4\u01af\u1eea\u1ee8\u1eec\u1eee\u1ef0\xdb\xdc\u016e\u016a","y\xfd\u1ef3\u1ef7\u1ef9\u1ef5\xff","Y\xdd\u1ef2\u1ef6\u1ef8\u1ef4\u0178","z\u017e\u017c\u017a","Z\u017d\u017b\u0179"]:["a\xe0\xe1\u1ea3\xe3\u1ea1\u0103\u1eb1\u1eaf\u1eb3\u1eb5\u1eb7\xe2\u1ea7\u1ea5\u1ea9\u1eab\u1ead\xe4\xe5\u0101\u0105A\xc0\xc1\u1ea2\xc3\u1ea0\u0102\u1eb0\u1eae\u1eb2\u1eb4\u1eb6\xc2\u1ea6\u1ea4\u1ea8\u1eaa\u1eac\xc4\xc5\u0100\u0104","c\xe7\u0107\u010dC\xc7\u0106\u010c","d\u0111\u010fD\u0110\u010e","e\xe8\xe9\u1ebb\u1ebd\u1eb9\xea\u1ec1\u1ebf\u1ec3\u1ec5\u1ec7\xeb\u011b\u0113\u0119E\xc8\xc9\u1eba\u1ebc\u1eb8\xca\u1ec0\u1ebe\u1ec2\u1ec4\u1ec6\xcb\u011a\u0112\u0118","i\xec\xed\u1ec9\u0129\u1ecb\xee\xef\u012bI\xcc\xcd\u1ec8\u0128\u1eca\xce\xcf\u012a","l\u0142L\u0141","n\xf1\u0148\u0144N\xd1\u0147\u0143","o\xf2\xf3\u1ecf\xf5\u1ecd\xf4\u1ed3\u1ed1\u1ed5\u1ed7\u1ed9\u01a1\u1edf\u1ee1\u1edb\u1edd\u1ee3\xf6\xf8\u014dO\xd2\xd3\u1ece\xd5\u1ecc\xd4\u1ed2\u1ed0\u1ed4\u1ed6\u1ed8\u01a0\u1ede\u1ee0\u1eda\u1edc\u1ee2\xd6\xd8\u014c","r\u0159R\u0158","s\u0161\u015b\u0219\u015fS\u0160\u015a\u0218\u015e","t\u0165\u021b\u0163T\u0164\u021a\u0162","u\xf9\xfa\u1ee7\u0169\u1ee5\u01b0\u1eeb\u1ee9\u1eed\u1eef\u1ef1\xfb\xfc\u016f\u016bU\xd9\xda\u1ee6\u0168\u1ee4\u01af\u1eea\u1ee8\u1eec\u1eee\u1ef0\xdb\xdc\u016e\u016a","y\xfd\u1ef3\u1ef7\u1ef9\u1ef5\xffY\xdd\u1ef2\u1ef6\u1ef8\u1ef4\u0178","z\u017e\u017c\u017aZ\u017d\u017b\u0179"];let i=[];return t.split("").forEach(r=>{s.every(s=>{if(-1!==s.indexOf(r)){if(i.indexOf(s)>-1)return!1;t=t.replace(new RegExp(`[${s}]`,`gm${e}`),`[${s}]`),i.push(s)}return!0})}),t}createMergedBlanksRegExp(t){return t.replace(/[\s]+/gim,"[\\s]+")}createAccuracyRegExp(t){const e="!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~\xa1\xbf";let s=this.opt.accuracy,i="string"==typeof s?s:s.value,r="string"==typeof s?[]:s.limiters,n="";switch(r.forEach(t=>{n+=`|${this.escapeStr(t)}`}),i){case"partially":default:return`()(${t})`;case"complementary":return`()([^${n="\\s"+(n||this.escapeStr(e))}]*${t}[^${n}]*)`;case"exactly":return`(^|\\s${n})(${t})(?=$|\\s${n})`}}getSeparatedKeywords(t){let e=[];return t.forEach(t=>{this.opt.separateWordSearch?t.split(" ").forEach(t=>{t.trim()&&-1===e.indexOf(t)&&e.push(t)}):t.trim()&&-1===e.indexOf(t)&&e.push(t)}),{keywords:e.sort((t,e)=>e.length-t.length),length:e.length}}isNumeric(t){return Number(parseFloat(t))==t}checkRanges(t){if(!Array.isArray(t)||"[object Object]"!==Object.prototype.toString.call(t[0]))return this.log("markRanges() will only accept an array of objects"),this.opt.noMatch(t),[];const e=[];let s=0;return t.sort((t,e)=>t.start-e.start).forEach(t=>{let{start:i,end:r,valid:n}=this.callNoMatchOnInvalidRanges(t,s);n&&(t.start=i,t.length=r-i,e.push(t),s=r)}),e}callNoMatchOnInvalidRanges(t,e){let s,i,r=!1;return t&&"undefined"!=typeof t.start?(i=(s=parseInt(t.start,10))+parseInt(t.length,10),this.isNumeric(t.start)&&this.isNumeric(t.length)&&i-e>0&&i-s>0?r=!0:(this.log("Ignoring invalid or overlapping range: "+`${JSON.stringify(t)}`),this.opt.noMatch(t))):(this.log(`Ignoring invalid range: ${JSON.stringify(t)}`),this.opt.noMatch(t)),{start:s,end:i,valid:r}}checkWhitespaceRanges(t,e,s){let i,r=!0,n=s.length,o=e-n,a=parseInt(t.start,10)-o;return(i=(a=a>n?n:a)+parseInt(t.length,10))>n&&(i=n,this.log(`End range automatically set to the max value of ${n}`)),a<0||i-a<0||a>n||i>n?(r=!1,this.log(`Invalid range: ${JSON.stringify(t)}`),this.opt.noMatch(t)):""===s.substring(a,i).replace(/\s+/g,"")&&(r=!1,this.log("Skipping whitespace only range: "+JSON.stringify(t)),this.opt.noMatch(t)),{start:a,end:i,valid:r}}getTextNodes(t){let e="",s=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,t=>{s.push({start:e.length,end:(e+=t.textContent).length,node:t})},t=>this.matchesExclude(t.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT,()=>{t({value:e,nodes:s})})}matchesExclude(t){return DOMIterator.matches(t,this.opt.exclude.concat(["script","style","title","head","html"]))}wrapRangeInTextNode(t,e,s){const i=this.opt.element?this.opt.element:"mark",r=t.splitText(e),n=r.splitText(s-e);let o=document.createElement(i);return o.setAttribute("data-markjs","true"),this.opt.className&&o.setAttribute("class",this.opt.className),o.textContent=r.textContent,r.parentNode.replaceChild(o,r),n}wrapRangeInMappedTextNode(t,e,s,i,r){t.nodes.every((n,o)=>{const a=t.nodes[o+1];if(void 0===a||a.start>e){if(!i(n.node))return!1;const a=e-n.start,h=(s>n.end?n.end:s)-n.start,c=t.value.substr(0,n.start),l=t.value.substr(h+n.start);if(n.node=this.wrapRangeInTextNode(n.node,a,h),t.value=c+l,t.nodes.forEach((e,s)=>{s>=o&&(t.nodes[s].start>0&&s!==o&&(t.nodes[s].start-=h),t.nodes[s].end-=h)}),s-=h,r(n.node.previousSibling,n.start),!(s>n.end))return!1;e=n.end}return!0})}wrapMatches(t,e,s,i,r){const n=0===e?0:e+1;this.getTextNodes(e=>{e.nodes.forEach(e=>{let r;for(e=e.node;null!==(r=t.exec(e.textContent))&&""!==r[n];){if(!s(r[n],e))continue;let o=r.index;if(0!==n)for(let t=1;t<n;t++)o+=r[t].length;e=this.wrapRangeInTextNode(e,o,o+r[n].length),i(e.previousSibling),t.lastIndex=0}}),r()})}wrapMatchesAcrossElements(t,e,s,i,r){const n=0===e?0:e+1;this.getTextNodes(e=>{let o;for(;null!==(o=t.exec(e.value))&&""!==o[n];){let r=o.index;if(0!==n)for(let t=1;t<n;t++)r+=o[t].length;const a=r+o[n].length;this.wrapRangeInMappedTextNode(e,r,a,t=>s(o[n],t),(e,s)=>{t.lastIndex=s,i(e)})}r()})}wrapRangeFromIndex(t,e,s,i){this.getTextNodes(r=>{const n=r.value.length;t.forEach((t,i)=>{let{start:o,end:a,valid:h}=this.checkWhitespaceRanges(t,n,r.value);h&&this.wrapRangeInMappedTextNode(r,o,a,s=>e(s,t,r.value.substring(o,a),i),e=>{s(e,t)})}),i()})}unwrapMatches(t){const e=t.parentNode;let s=document.createDocumentFragment();for(;t.firstChild;)s.appendChild(t.removeChild(t.firstChild));e.replaceChild(s,t),this.ie?this.normalizeTextNode(e):e.normalize()}normalizeTextNode(t){if(t){if(3===t.nodeType)for(;t.nextSibling&&3===t.nextSibling.nodeType;)t.nodeValue+=t.nextSibling.nodeValue,t.parentNode.removeChild(t.nextSibling);else this.normalizeTextNode(t.firstChild);this.normalizeTextNode(t.nextSibling)}}markRegExp(t,e){this.opt=e,this.log(`Searching with expression "${t}"`);let s=0,i="wrapMatches";const r=t=>{s++,this.opt.each(t)};this.opt.acrossElements&&(i="wrapMatchesAcrossElements"),this[i](t,this.opt.ignoreGroups,(t,e)=>this.opt.filter(e,t,s),r,()=>{0===s&&this.opt.noMatch(t),this.opt.done(s)})}mark(t,e){this.opt=e;let s=0,i="wrapMatches";const{keywords:r,length:n}=this.getSeparatedKeywords("string"==typeof t?[t]:t),o=this.opt.caseSensitive?"":"i",a=t=>{let e=new RegExp(this.createRegExp(t),`gm${o}`),h=0;this.log(`Searching with expression "${e}"`),this[i](e,1,(e,i)=>this.opt.filter(i,t,s,h),t=>{h++,s++,this.opt.each(t)},()=>{0===h&&this.opt.noMatch(t),r[n-1]===t?this.opt.done(s):a(r[r.indexOf(t)+1])})};this.opt.acrossElements&&(i="wrapMatchesAcrossElements"),0===n?this.opt.done(s):a(r[0])}markRanges(t,e){this.opt=e;let s=0,i=this.checkRanges(t);i&&i.length?(this.log("Starting to mark with the following ranges: "+JSON.stringify(i)),this.wrapRangeFromIndex(i,(t,e,s,i)=>this.opt.filter(t,e,s,i),(t,e)=>{s++,this.opt.each(t,e)},()=>{this.opt.done(s)})):this.opt.done(s)}unmark(t){this.opt=t;let e=this.opt.element?this.opt.element:"*";e+="[data-markjs]",this.opt.className&&(e+=`.${this.opt.className}`),this.log(`Removal selector "${e}"`),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,t=>{this.unwrapMatches(t)},t=>{const s=DOMIterator.matches(t,e),i=this.matchesExclude(t);return!s||i?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},this.opt.done)}};